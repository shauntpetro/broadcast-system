<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouTube Chat OBS Output</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Oswald:wght@400;500;600;700&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Source Sans Pro', sans-serif;
      background: transparent;
      overflow: hidden;
      width: 100%;
      height: 100vh;
      display: flex;
      padding: 40px;
    }

    /* Position variants */
    body.pos-bottom-left { align-items: flex-end; justify-content: flex-start; }
    body.pos-bottom-right { align-items: flex-end; justify-content: flex-end; }
    body.pos-bottom-center { align-items: flex-end; justify-content: center; }
    body.pos-top-left { align-items: flex-start; justify-content: flex-start; }
    body.pos-top-right { align-items: flex-start; justify-content: flex-end; }
    body.pos-top-center { align-items: flex-start; justify-content: center; }
    body.pos-center { align-items: center; justify-content: center; }
    body.pos-center-left { align-items: center; justify-content: flex-start; }
    body.pos-center-right { align-items: center; justify-content: flex-end; }

    /* ========================================
       Clean Broadcast Style
    ======================================== */

    /* Main Container */
    .pinned-container {
      visibility: hidden;
      opacity: 0;
      max-width: 600px;
      min-width: 420px;
      position: relative;
    }

    /* Top accent bar */
    .pinned-label {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: var(--accent-color, #c41e3a);
      z-index: 5;
    }

    /* Bottom accent bar */
    .bottom-accent {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: var(--accent-color, #c41e3a);
      z-index: 5;
    }

    /* Main Card */
    .pinned-card {
      background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
      padding: 32px 28px 32px 28px;
      position: relative;
      box-shadow:
        0 4px 20px rgba(0, 0, 0, 0.15),
        0 8px 40px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
      margin: 5px 0;
      border-radius: 2px;
    }

    /* Content wrapper */
    .content-wrapper {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      gap: 20px;
    }

    /* Avatar */
    .avatar {
      flex-shrink: 0;
      width: 72px;
      height: 72px;
      border-radius: 50%;
      overflow: hidden;
      background: linear-gradient(135deg, var(--accent-color, #c41e3a) 0%, rgba(0,0,0,0.2) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow:
        0 0 0 3px white,
        0 0 0 5px var(--accent-color, #c41e3a),
        0 4px 12px rgba(0, 0, 0, 0.2);
      position: relative;
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .avatar .initial {
      font-family: 'Oswald', sans-serif;
      font-size: 36px;
      font-weight: 700;
      color: white;
      text-transform: uppercase;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    /* Text content */
    .text-content {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    /* Type Label */
    .type-label {
      font-family: 'Oswald', sans-serif;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--accent-color, #c41e3a);
      margin-bottom: 4px;
    }

    /* Username - Heavy Italic */
    .username {
      font-family: 'Oswald', sans-serif;
      font-size: 38px;
      font-weight: 700;
      font-style: italic;
      color: #1a1a1a;
      text-transform: uppercase;
      letter-spacing: 1px;
      line-height: 1.1;
    }

    /* Message - Lighter font */
    .message {
      font-family: 'Source Sans Pro', serif;
      font-size: 24px;
      font-weight: 300;
      font-style: italic;
      color: #333;
      line-height: 1.4;
      margin-top: 8px;
      position: relative;
      padding-left: 20px;
    }

    /* Quote mark */
    .message::before {
      content: '"';
      position: absolute;
      left: 0;
      top: -5px;
      font-size: 40px;
      color: var(--accent-color, #c41e3a);
      font-family: Georgia, serif;
      opacity: 0.6;
    }

    /* Amount for Superchats */
    .amount {
      font-family: 'Oswald', sans-serif;
      font-size: 28px;
      font-weight: 600;
      color: var(--accent-color, #c41e3a);
      letter-spacing: 1px;
      margin-top: 8px;
    }

    /* Badge */
    .badge {
      display: inline-block;
      font-family: 'Oswald', sans-serif;
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 2px;
      text-transform: uppercase;
      padding: 4px 10px;
      background: #f0f0f0;
      color: #666;
      margin-left: 12px;
      vertical-align: middle;
    }

    .badge.member { background: #2e7d32; color: white; }
    .badge.mod { background: #1565c0; color: white; }
    .badge.owner { background: #f57c00; color: white; }
    .badge.verified { background: #7c4dff; color: white; }

    /* ========================================
       Superchat Tier Colors
    ======================================== */
    .tier-blue { --accent-color: #1e88e5; }
    .tier-teal { --accent-color: #00bcd4; }
    .tier-yellow { --accent-color: #f9a825; }
    .tier-orange { --accent-color: #f57c00; }
    .tier-magenta { --accent-color: #e91e63; }
    .tier-red { --accent-color: #c41e3a; }
    .tier-comment { --accent-color: #c41e3a; }

    /* Tier 7 special effect */
    .tier-7 .pinned-card {
      box-shadow:
        0 4px 20px rgba(0, 0, 0, 0.15),
        0 8px 40px rgba(0, 0, 0, 0.1),
        0 0 30px rgba(196, 30, 58, 0.3);
    }

    /* ========================================
       Waiting State (debug only)
    ======================================== */
    .waiting-message {
      display: none;
      color: rgba(255, 255, 255, 0.3);
      font-family: 'Oswald', sans-serif;
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 4px;
    }

    body.debug .waiting-message {
      display: block;
    }
  </style>
</head>
<body>
  <!-- Pinned Comment Display (click to unpin) -->
  <div id="pinnedContainer" class="pinned-container" onclick="unpinComment()" style="cursor: pointer;" title="Click to unpin">
    <!-- Top accent bar -->
    <div class="pinned-label" id="pinnedLabel"></div>

    <!-- Main Card -->
    <div class="pinned-card" id="pinnedCard">
      <div class="content-wrapper" id="contentWrapper">
        <!-- Avatar -->
        <div class="avatar" id="avatar">
          <span class="initial" id="avatarInitial">?</span>
          <img id="avatarImg" src="" alt="" style="display: none;">
        </div>
        <!-- Text Content -->
        <div class="text-content">
          <div class="type-label" id="typeLabel">COMMENT</div>
          <div class="header" id="header">
            <span class="username" id="username">Username</span>
            <span class="badge" id="badge" style="display: none;"></span>
          </div>
          <div class="message" id="message">Message text goes here</div>
          <div class="amount" id="amount" style="display: none;"></div>
        </div>
      </div>
    </div>

    <!-- Bottom accent bar -->
    <div class="bottom-accent" id="bottomAccent"></div>
  </div>

  <!-- Debug waiting message -->
  <div class="waiting-message">Waiting for pinned comment...</div>

  <script>
    // ========================================================================
    // Configuration
    // ========================================================================
    const params = new URLSearchParams(window.location.search);
    const debug = params.get('debug') === 'true';

    if (debug) {
      document.body.classList.add('debug');
    }

    // Position: bottom-left (default), bottom-right, bottom-center,
    //           top-left, top-right, top-center,
    //           center, center-left, center-right
    const position = params.get('position') || 'bottom-left';
    document.body.classList.add(`pos-${position}`);

    // ========================================================================
    // State
    // ========================================================================
    let ws = null;
    let currentPinned = null;
    let isAnimating = false;

    // DOM Elements
    const container = document.getElementById('pinnedContainer');
    const labelEl = document.getElementById('pinnedLabel');
    const cardEl = document.getElementById('pinnedCard');
    const contentWrapper = document.getElementById('contentWrapper');
    const avatarEl = document.getElementById('avatar');
    const avatarInitialEl = document.getElementById('avatarInitial');
    const avatarImgEl = document.getElementById('avatarImg');
    const typeLabel = document.getElementById('typeLabel');
    const headerEl = document.getElementById('header');
    const usernameEl = document.getElementById('username');
    const badgeEl = document.getElementById('badge');
    const messageEl = document.getElementById('message');
    const amountEl = document.getElementById('amount');
    const bottomAccent = document.getElementById('bottomAccent');

    // ========================================================================
    // Superchat Tier System
    // ========================================================================
    function getTier(amount) {
      if (!amount) return { tier: 'comment', tierNum: 0, color: '#c41e3a' };

      const num = parseFloat(String(amount).replace(/[^0-9.]/g, ''));

      if (num >= 100) return { tier: 'red', tierNum: 7, color: '#c41e3a' };
      if (num >= 50) return { tier: 'red', tierNum: 6, color: '#c41e3a' };
      if (num >= 20) return { tier: 'magenta', tierNum: 5, color: '#e91e63' };
      if (num >= 10) return { tier: 'orange', tierNum: 4, color: '#f57c00' };
      if (num >= 5) return { tier: 'yellow', tierNum: 3, color: '#f9a825' };
      if (num >= 2) return { tier: 'teal', tierNum: 2, color: '#00bcd4' };
      if (num >= 1) return { tier: 'blue', tierNum: 1, color: '#1e88e5' };

      return { tier: 'comment', tierNum: 0, color: '#c41e3a' };
    }

    // ========================================================================
    // Render Pinned Comment
    // ========================================================================
    function renderPinned(pinned) {
      if (!pinned) return;

      const isSuperchat = pinned.isSuperchat || pinned.type === 'superchat';
      const tierInfo = isSuperchat ? getTier(pinned.amount) : { tier: 'comment', tierNum: 0, color: '#c41e3a' };

      // Remove old tier classes
      container.className = 'pinned-container';
      container.classList.add(`tier-${tierInfo.tier}`);
      if (tierInfo.tierNum === 7) {
        container.classList.add('tier-7');
      }

      // Set CSS variable for accent color
      container.style.setProperty('--accent-color', tierInfo.color);

      // Update avatar
      if (pinned.authorPhoto || pinned.avatar) {
        avatarImgEl.src = pinned.authorPhoto || pinned.avatar;
        avatarImgEl.style.display = 'block';
        avatarInitialEl.style.display = 'none';
      } else {
        const initial = (pinned.author || pinned.username || 'U')[0].toUpperCase();
        avatarInitialEl.textContent = initial;
        avatarInitialEl.style.display = 'block';
        avatarImgEl.style.display = 'none';
      }

      // Update type label
      typeLabel.textContent = isSuperchat ? 'SUPERCHAT' : 'COMMENT';

      // Update username
      usernameEl.textContent = pinned.author || pinned.username || 'Unknown';

      // Update badge
      const badges = pinned.badges || [];
      if (badges.includes('owner') || pinned.isOwner) {
        badgeEl.textContent = 'OWNER';
        badgeEl.className = 'badge owner';
        badgeEl.style.display = 'inline-block';
      } else if (badges.includes('moderator') || pinned.isMod) {
        badgeEl.textContent = 'MOD';
        badgeEl.className = 'badge mod';
        badgeEl.style.display = 'inline-block';
      } else if (badges.includes('member') || pinned.isMember) {
        badgeEl.textContent = 'MEMBER';
        badgeEl.className = 'badge member';
        badgeEl.style.display = 'inline-block';
      } else if (badges.includes('verified')) {
        badgeEl.textContent = 'VERIFIED';
        badgeEl.className = 'badge verified';
        badgeEl.style.display = 'inline-block';
      } else {
        badgeEl.style.display = 'none';
      }

      // Update message
      messageEl.textContent = pinned.message || '';

      // Update amount
      if (isSuperchat && (pinned.amountFormatted || pinned.amount)) {
        amountEl.textContent = pinned.amountFormatted || `$${pinned.amount}`;
        amountEl.style.display = 'block';
      } else {
        amountEl.style.display = 'none';
      }
    }

    // ========================================================================
    // Clean Broadcast Animations
    // ========================================================================
    function animateIn(pinned) {
      if (isAnimating) return;
      isAnimating = true;

      renderPinned(pinned);
      currentPinned = pinned;

      // Kill any existing animations
      gsap.killTweensOf([container, labelEl, cardEl, contentWrapper, avatarEl, typeLabel, headerEl, messageEl, amountEl, bottomAccent]);

      // Set initial states
      gsap.set(container, { visibility: 'visible', opacity: 1 });

      // Card starts scaled down and from the left
      gsap.set(cardEl, { x: -80, opacity: 0, scaleY: 0.9 });
      gsap.set(labelEl, { scaleX: 0, transformOrigin: 'left center' });
      gsap.set(bottomAccent, { scaleX: 0, transformOrigin: 'right center' });

      // Content starts faded
      gsap.set(contentWrapper, { opacity: 0 });
      gsap.set(avatarEl, { scale: 0, rotation: -90, opacity: 0 });
      gsap.set(typeLabel, { y: -15, opacity: 0 });
      gsap.set(headerEl, { x: -30, opacity: 0 });
      gsap.set(messageEl, { y: 20, opacity: 0 });
      gsap.set(amountEl, { opacity: 0, scale: 0.8 });

      // Create staggered timeline
      const tl = gsap.timeline({
        onComplete: () => {
          isAnimating = false;
          console.log('[OBS] Animation complete:', pinned.author);
        }
      });

      // 1. Card slides in and scales
      tl.to(cardEl, {
        x: 0,
        opacity: 1,
        scaleY: 1,
        duration: 0.5,
        ease: 'power3.out'
      });

      // 2. Top accent bar sweeps in
      tl.to(labelEl, {
        scaleX: 1,
        duration: 0.4,
        ease: 'power2.out'
      }, '-=0.3');

      // 3. Bottom accent bar sweeps in (opposite direction)
      tl.to(bottomAccent, {
        scaleX: 1,
        duration: 0.4,
        ease: 'power2.out'
      }, '-=0.35');

      // 4. Content wrapper fades in
      tl.to(contentWrapper, {
        opacity: 1,
        duration: 0.2
      }, '-=0.2');

      // 5. Avatar spins in
      tl.to(avatarEl, {
        scale: 1,
        rotation: 0,
        opacity: 1,
        duration: 0.5,
        ease: 'back.out(1.7)'
      }, '-=0.15');

      // 6. Type label drops in
      tl.to(typeLabel, {
        y: 0,
        opacity: 1,
        duration: 0.35,
        ease: 'power2.out'
      }, '-=0.2');

      // 7. Username slides in
      tl.to(headerEl, {
        x: 0,
        opacity: 1,
        duration: 0.4,
        ease: 'power2.out'
      }, '-=0.2');

      // 8. Message rises up
      tl.to(messageEl, {
        y: 0,
        opacity: 1,
        duration: 0.45,
        ease: 'power2.out'
      }, '-=0.25');

      // 9. Amount pops in (if superchat)
      if (amountEl.style.display !== 'none') {
        tl.to(amountEl, {
          opacity: 1,
          scale: 1,
          duration: 0.35,
          ease: 'back.out(1.5)'
        }, '-=0.2');
      }

      console.log('[OBS] Animating in:', pinned.author);
    }

    function animateOut(callback) {
      if (isAnimating) return;
      isAnimating = true;

      // Create exit timeline
      const tl = gsap.timeline({
        onComplete: () => {
          gsap.set(container, { visibility: 'hidden' });
          currentPinned = null;
          isAnimating = false;
          if (callback) callback();
          console.log('[OBS] Animation out complete');
        }
      });

      // 1. Content fades out quickly
      tl.to([typeLabel, headerEl, messageEl, amountEl], {
        opacity: 0,
        duration: 0.2,
        ease: 'power2.in'
      });

      // 2. Avatar shrinks out
      tl.to(avatarEl, {
        scale: 0.5,
        rotation: 45,
        opacity: 0,
        duration: 0.25,
        ease: 'power2.in'
      }, '-=0.15');

      // 3. Accent bars retract
      tl.to(labelEl, {
        scaleX: 0,
        duration: 0.3,
        ease: 'power2.in'
      }, '-=0.1');

      tl.to(bottomAccent, {
        scaleX: 0,
        duration: 0.3,
        ease: 'power2.in'
      }, '-=0.28');

      // 4. Card slides out
      tl.to(cardEl, {
        x: -60,
        opacity: 0,
        scaleY: 0.95,
        duration: 0.35,
        ease: 'power2.in'
      }, '-=0.2');

      console.log('[OBS] Animating out');
    }

    // ========================================================================
    // Click to Unpin
    // ========================================================================
    function unpinComment() {
      if (currentPinned && ws && ws.readyState === WebSocket.OPEN) {
        console.log('[OBS] Unpinning via click');
        ws.send(JSON.stringify({ type: 'unpin' }));
      }
    }

    // ========================================================================
    // Handle Pin Updates
    // ========================================================================
    function handlePinUpdate(pinnedMessage) {
      if (pinnedMessage && !currentPinned) {
        // New pin - animate in
        animateIn(pinnedMessage);
      } else if (!pinnedMessage && currentPinned) {
        // Unpin - animate out
        animateOut();
      } else if (pinnedMessage && currentPinned) {
        // Different pin - animate out then in
        if (pinnedMessage.id !== currentPinned.id) {
          animateOut(() => {
            setTimeout(() => animateIn(pinnedMessage), 150);
          });
        }
      }
    }

    // ========================================================================
    // WebSocket Connection
    // ========================================================================
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}`;

      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log('[OBS] WebSocket connected');
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          handleOBSMessage(data);
        } catch (e) {
          console.error('[OBS] Parse error:', e);
        }
      };

      ws.onclose = () => {
        console.log('[OBS] WebSocket disconnected, reconnecting...');
        setTimeout(connectWebSocket, 2000);
      };

      ws.onerror = (error) => {
        console.error('[OBS] WebSocket error:', error);
      };
    }

    function handleOBSMessage(data) {
      switch (data.type) {
        case 'batch':
          // Handle batched messages
          if (data.messages && Array.isArray(data.messages)) {
            for (const msg of data.messages) {
              handleOBSMessage(msg);
            }
          }
          break;

        case 'init':
          if (data.data.pinnedMessage) {
            handlePinUpdate(data.data.pinnedMessage);
          }
          break;

        case 'pin':
          handlePinUpdate(data.data.message);
          break;
      }
    }

    // ========================================================================
    // Initialize
    // ========================================================================
    connectWebSocket();

    // Debug: Test animation with URL param
    if (params.get('test') === 'true') {
      setTimeout(() => {
        handlePinUpdate({
          id: 'test_1',
          author: 'Darren Fletcher',
          message: 'This is absolutely incredible content! The production quality is next level.',
          isSuperchat: false,
          badges: ['member'],
          authorPhoto: ''
        });
      }, 1000);

      // Test superchat after 6 seconds
      setTimeout(() => {
        handlePinUpdate({
          id: 'test_2',
          author: 'BigSupporter',
          message: 'Amazing stream! Here is my support for the channel - keep up the great work!',
          isSuperchat: true,
          amount: 50,
          amountFormatted: '$50.00',
          badges: [],
          authorPhoto: ''
        });
      }, 7000);

      // Test unpin after 13 seconds
      setTimeout(() => {
        handlePinUpdate(null);
      }, 14000);
    }
  </script>
</body>
</html>
