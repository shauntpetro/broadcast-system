<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Semeex Football - Agenda Panel</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Oswald:wght@400;500;600;700&family=Special+Gothic+Expanded+One&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Oswald', sans-serif;
      background: transparent;
      overflow: hidden;
      width: 100%;
      height: 100vh;
      display: flex;
      padding: 0;
    }

    /* Position variants */
    body.pos-left { justify-content: flex-start; align-items: stretch; }
    body.pos-right { justify-content: flex-end; align-items: stretch; }

    /* ========================================
       Semeex Football Agenda Panel
       Talk of the Devils / ESPN Style
    ======================================== */

    :root {
      color-scheme: dark;
      --semeex-gold: #f5d000;
      --semeex-gold-light: #ffe55c;
      --semeex-gold-dark: #c9a800;
      --semeex-red: #da020e;
      --semeex-red-dark: #a00008;
      --panel-dark: #0d0d0d;
      --panel-bg: rgba(13, 13, 13, 0.95);
    }

    .agenda-container {
      visibility: hidden;
      opacity: 0;
      display: flex;
      flex-direction: column;
      width: 480px;
      height: 100vh;
      position: relative;
    }

    /* Right edge accent bar */
    .edge-accent {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 6px;
      background: linear-gradient(180deg,
        var(--semeex-red) 0%,
        var(--semeex-red-dark) 50%,
        #1a0003 100%
      );
      box-shadow: -4px 0 20px rgba(218, 2, 14, 0.4);
      z-index: 10;
    }

    body.pos-right .edge-accent {
      right: auto;
      left: 0;
      box-shadow: 4px 0 20px rgba(218, 2, 14, 0.4);
    }

    /* Main Panel Background */
    .panel-background {
      position: absolute;
      inset: 0;
      right: 6px;
      background: var(--panel-bg);
      backdrop-filter: blur(10px);
    }

    body.pos-right .panel-background {
      right: 0;
      left: 6px;
    }

    /* Heavy grain/noise texture overlay */
    .panel-background::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      opacity: 0.08;
      pointer-events: none;
      mix-blend-mode: overlay;
    }

    /* Scanline overlay */
    .panel-background::after {
      content: '';
      position: absolute;
      inset: 0;
      background:
        repeating-linear-gradient(
          0deg,
          transparent 0px,
          transparent 2px,
          rgba(0, 0, 0, 0.15) 2px,
          rgba(0, 0, 0, 0.15) 4px
        );
      pointer-events: none;
      opacity: 0.6;
    }

    /* Additional film grain texture layer */
    .grain-overlay {
      position: absolute;
      inset: 0;
      z-index: 2;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='grain'%3E%3CfeTurbulence type='turbulence' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23grain)'/%3E%3C/svg%3E");
      opacity: 0.04;
      pointer-events: none;
      mix-blend-mode: soft-light;
      animation: grainShift 0.5s steps(10) infinite;
    }

    @keyframes grainShift {
      0%, 100% { transform: translate(0, 0); }
      10% { transform: translate(-1%, -1%); }
      20% { transform: translate(1%, 1%); }
      30% { transform: translate(-1%, 1%); }
      40% { transform: translate(1%, -1%); }
      50% { transform: translate(-0.5%, 0.5%); }
      60% { transform: translate(0.5%, -0.5%); }
      70% { transform: translate(-1%, -0.5%); }
      80% { transform: translate(0.5%, 1%); }
      90% { transform: translate(-0.5%, -1%); }
    }

    /* Vignette effect */
    .vignette-overlay {
      position: absolute;
      inset: 0;
      z-index: 3;
      background: radial-gradient(
        ellipse at center,
        transparent 40%,
        rgba(0, 0, 0, 0.3) 100%
      );
      pointer-events: none;
    }

    /* Content wrapper */
    .panel-content {
      position: relative;
      z-index: 5;
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 40px 30px 40px 30px;
    }

    body.pos-right .panel-content {
      padding-left: 40px;
    }

    /* Header Section with Logo */
    .agenda-header {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-bottom: 30px;
    }

    .header-logo {
      width: 280px;
      height: auto;
      margin-bottom: 20px;
      filter: drop-shadow(0 4px 15px rgba(0, 0, 0, 0.8));
    }

    .header-logo img {
      width: 100%;
      height: auto;
      object-fit: contain;
    }

    /* Items Container */
    .agenda-items {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0;
      overflow: hidden;
    }

    /* Individual Item */
    .agenda-item {
      display: flex;
      flex-direction: column;
      padding: 24px 0;
      position: relative;
    }

    /* Divider line under each item */
    .agenda-item::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 20px;
      height: 2px;
      background: linear-gradient(90deg,
        rgba(255, 255, 255, 0.3) 0%,
        rgba(255, 255, 255, 0.1) 70%,
        transparent 100%
      );
    }

    .agenda-item:last-child::after {
      display: none;
    }

    /* Item Title - Bold uppercase like Talk of the Devils */
    .item-title {
      font-family: 'Oswald', sans-serif;
      font-size: 32px;
      font-weight: 700;
      color: #ffffff;
      text-transform: uppercase;
      letter-spacing: 1px;
      line-height: 1.2;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
      transition: all 0.3s ease;
    }

    /* Current State - highlighted */
    .agenda-item.current .item-title {
      color: var(--semeex-gold);
      text-shadow:
        0 0 30px rgba(245, 208, 0, 0.5),
        0 2px 8px rgba(0, 0, 0, 0.8);
    }

    .agenda-item.current::before {
      content: '';
      position: absolute;
      left: -30px;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 60%;
      background: var(--semeex-gold);
      box-shadow: 2px 0 15px rgba(245, 208, 0, 0.5);
    }

    /* Completed State - dimmed */
    .agenda-item.completed .item-title {
      color: rgba(255, 255, 255, 0.4);
    }

    /* Upcoming State (default) */
    .agenda-item.upcoming .item-title {
      color: rgba(255, 255, 255, 0.85);
    }

    /* ========================================
       Debug / Waiting State
    ======================================== */

    .waiting-message {
      display: none;
      color: rgba(255, 255, 255, 0.25);
      font-family: 'Oswald', sans-serif;
      font-size: 18px;
      text-transform: uppercase;
      letter-spacing: 5px;
      padding: 40px;
    }

    body.debug .waiting-message {
      display: block;
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <!-- Semeex Football Agenda Panel -->
  <div id="agendaContainer" class="agenda-container">
    <!-- Edge accent bar -->
    <div class="edge-accent" id="edgeAccent"></div>

    <!-- Background -->
    <div class="panel-background" id="panelBg"></div>

    <!-- Film grain overlay -->
    <div class="grain-overlay"></div>

    <!-- Vignette overlay -->
    <div class="vignette-overlay"></div>

    <!-- Content -->
    <div class="panel-content">
      <!-- Header with Logo -->
      <div class="agenda-header" id="agendaHeader">
        <div class="header-logo">
          <img src="/public/logos/SemeexLogoStacked.png" alt="Semeex Football" id="headerLogoImg">
        </div>
      </div>

      <!-- Items -->
      <div class="agenda-items" id="agendaItems">
        <!-- Items populated via JS -->
      </div>
    </div>
  </div>

  <!-- Debug waiting message -->
  <div class="waiting-message">Waiting for agenda data...</div>

  <script>
    // ========================================================================
    // Configuration
    // ========================================================================
    const params = new URLSearchParams(window.location.search);
    const debug = params.get('debug') === 'true';

    if (debug) {
      document.body.classList.add('debug');
    }

    const position = params.get('position') || 'left';
    document.body.classList.add(`pos-${position}`);

    console.log('[Agenda] Position:', position);

    // ========================================================================
    // State
    // ========================================================================
    let ws = null;
    let currentItems = [];
    let currentTitle = "TODAY'S AGENDA";
    let isVisible = false;
    let isAnimating = false;

    // DOM Elements
    const container = document.getElementById('agendaContainer');
    const edgeAccent = document.getElementById('edgeAccent');
    const panelBg = document.getElementById('panelBg');
    const headerEl = document.getElementById('agendaHeader');
    const itemsContainer = document.getElementById('agendaItems');

    // ========================================================================
    // Render Agenda
    // ========================================================================
    function renderAgenda(items, title) {
      if (!items || items.length === 0) return;

      // Clear existing items
      itemsContainer.innerHTML = '';

      // Create item elements
      items.forEach((item, index) => {
        const itemEl = document.createElement('div');
        itemEl.className = 'agenda-item';
        itemEl.dataset.index = index;

        // Determine state
        if (item.completed) {
          itemEl.classList.add('completed');
        } else if (item.current) {
          itemEl.classList.add('current');
        } else {
          itemEl.classList.add('upcoming');
        }

        // Title
        const titleEl = document.createElement('div');
        titleEl.className = 'item-title';
        titleEl.textContent = item.title || `Topic ${index + 1}`;

        itemEl.appendChild(titleEl);
        itemsContainer.appendChild(itemEl);
      });
    }

    // ========================================================================
    // Animations
    // ========================================================================
    function animateIn(items, title) {
      if (isAnimating || isVisible) return;
      isAnimating = true;

      renderAgenda(items, title);
      currentItems = items;
      currentTitle = title;

      // Kill existing animations
      gsap.killTweensOf([container, edgeAccent, panelBg, headerEl, '.agenda-item']);

      // Initial states
      gsap.set(container, { visibility: 'visible', opacity: 1 });

      const isRight = position === 'right';
      const slideDir = isRight ? 1 : -1;

      gsap.set(panelBg, { x: slideDir * 100 + '%', opacity: 0 });
      gsap.set(edgeAccent, { scaleY: 0, transformOrigin: 'top center' });
      gsap.set(headerEl, { opacity: 0, y: -20 });

      const itemEls = document.querySelectorAll('.agenda-item');
      gsap.set(itemEls, { x: slideDir * 50, opacity: 0 });

      const tl = gsap.timeline({
        onComplete: () => {
          isAnimating = false;
          isVisible = true;
          console.log('[Agenda] Animation complete');
        }
      });

      // Panel background slides in
      tl.to(panelBg, {
        x: 0,
        opacity: 1,
        duration: 0.5,
        ease: 'power3.out'
      });

      // Edge accent grows down
      tl.to(edgeAccent, {
        scaleY: 1,
        duration: 0.4,
        ease: 'power2.out'
      }, '-=0.35');

      // Header fades in
      tl.to(headerEl, {
        opacity: 1,
        y: 0,
        duration: 0.4,
        ease: 'power2.out'
      }, '-=0.3');

      // Items stagger in
      tl.to(itemEls, {
        x: 0,
        opacity: 1,
        duration: 0.35,
        stagger: 0.1,
        ease: 'power2.out'
      }, '-=0.2');

      console.log('[Agenda] Animating in with', items.length, 'items');
    }

    function animateOut(callback) {
      if (isAnimating || !isVisible) {
        if (callback) callback();
        return;
      }
      isAnimating = true;

      const itemEls = document.querySelectorAll('.agenda-item');
      const isRight = position === 'right';
      const slideDir = isRight ? 1 : -1;

      const tl = gsap.timeline({
        onComplete: () => {
          gsap.set(container, { visibility: 'hidden' });
          currentItems = [];
          isAnimating = false;
          isVisible = false;
          if (callback) callback();
          console.log('[Agenda] Animation out complete');
        }
      });

      // Items stagger out (reverse order)
      tl.to(itemEls, {
        x: slideDir * 30,
        opacity: 0,
        duration: 0.25,
        stagger: -0.05,
        ease: 'power2.in'
      });

      // Header fades out
      tl.to(headerEl, {
        opacity: 0,
        y: -15,
        duration: 0.25,
        ease: 'power2.in'
      }, '-=0.15');

      // Edge accent shrinks
      tl.to(edgeAccent, {
        scaleY: 0,
        duration: 0.3,
        ease: 'power2.in'
      }, '-=0.2');

      // Panel slides out
      tl.to(panelBg, {
        x: slideDir * 100 + '%',
        opacity: 0,
        duration: 0.35,
        ease: 'power3.in'
      }, '-=0.25');

      console.log('[Agenda] Animating out');
    }

    function updateItems(items, title) {
      if (!isVisible) {
        animateIn(items, title);
        return;
      }

      // Update without full re-animation if just item states changed
      currentItems = items;
      currentTitle = title;

      const itemEls = document.querySelectorAll('.agenda-item');
      itemEls.forEach((el, index) => {
        if (index >= items.length) return;

        const item = items[index];
        const titleEl = el.querySelector('.item-title');

        // Update state classes with animation
        const wasCurrentOrCompleted = el.classList.contains('current') || el.classList.contains('completed');

        el.classList.remove('completed', 'current', 'upcoming');
        if (item.completed) {
          el.classList.add('completed');
        } else if (item.current) {
          el.classList.add('current');
          // Pulse animation for newly current item
          if (!wasCurrentOrCompleted || !el.classList.contains('current')) {
            gsap.fromTo(titleEl,
              { scale: 1 },
              { scale: 1.05, duration: 0.2, yoyo: true, repeat: 1, ease: 'power2.out' }
            );
          }
        } else {
          el.classList.add('upcoming');
        }

        titleEl.textContent = item.title;
      });
    }

    // ========================================================================
    // Handle Agenda Updates
    // ========================================================================
    function handleAgendaUpdate(data) {
      const items = data.agendaItems || [];
      const title = data.agendaTitle || "TODAY'S AGENDA";
      const show = data.showAgenda !== false;

      if (show && items.length > 0) {
        if (!isVisible) {
          animateIn(items, title);
        } else {
          updateItems(items, title);
        }
      } else if (isVisible) {
        animateOut();
      }
    }

    // ========================================================================
    // WebSocket Connection
    // ========================================================================
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}`;

      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log('[Agenda] WebSocket connected');
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          handleMessage(data);
        } catch (e) {
          console.error('[Agenda] Parse error:', e);
        }
      };

      ws.onclose = () => {
        console.log('[Agenda] WebSocket disconnected, reconnecting...');
        setTimeout(connectWebSocket, 2000);
      };

      ws.onerror = (error) => {
        console.error('[Agenda] WebSocket error:', error);
      };
    }

    function handleMessage(data) {
      switch (data.type) {
        case 'batch':
          if (data.messages && Array.isArray(data.messages)) {
            for (const msg of data.messages) {
              handleMessage(msg);
            }
          }
          break;

        case 'init':
          if (data.data.agendaItems) {
            handleAgendaUpdate(data.data);
          }
          break;

        case 'agenda_update':
          handleAgendaUpdate(data.data);
          break;
      }
    }

    // ========================================================================
    // Initialize
    // ========================================================================
    connectWebSocket();

    // Debug: Test animation
    if (params.get('test') === 'true') {
      const testData = {
        agendaTitle: "TODAY'S TOPICS",
        showAgenda: true,
        agendaItems: [
          { title: 'MAN UNITED OUT OF FA CUP', completed: true, current: false },
          { title: 'CARRICK LEADING INTERIM OPTION', completed: true, current: false },
          { title: 'CAN UNITED SALVAGE 25/26?', completed: false, current: true },
          { title: 'VIEWER Q&A SESSION', completed: false, current: false },
          { title: 'MATCH PREDICTIONS', completed: false, current: false }
        ]
      };

      setTimeout(() => {
        handleAgendaUpdate(testData);
      }, 1000);

      // Test updating item states
      setTimeout(() => {
        testData.agendaItems[2].completed = true;
        testData.agendaItems[2].current = false;
        testData.agendaItems[3].current = true;
        handleAgendaUpdate(testData);
      }, 6000);

      // Test hide
      setTimeout(() => {
        handleAgendaUpdate({ showAgenda: false, agendaItems: [] });
      }, 12000);

      // Test show again
      setTimeout(() => {
        handleAgendaUpdate(testData);
      }, 14000);
    }
  </script>
</body>
</html>
