<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Broadcast Ticker</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;600;700&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,600;1,300;1,400&display=swap" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Special+Gothic+Expanded+One&family=Bebas+Neue&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Oswald', sans-serif;
      background: transparent;
      overflow: hidden;
      width: 100%;
      height: 100vh;
    }

    /* ========================================
       Ticker Container - Clean Broadcast Style
    ======================================== */
    .ticker-wrapper {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      min-height: 100px;
    }

    /* Top accent bar */
    .accent-bar-top {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--accent-color, #c41e3a);
      z-index: 5;
    }

    /* Bottom accent bar */
    .accent-bar-bottom {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--accent-color, #c41e3a);
      z-index: 5;
    }

    /* Main Panel */
    .ticker-paper {
      background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
      margin: 4px 0;
      padding: 16px 24px;
      position: relative;
      box-shadow:
        0 4px 20px rgba(0, 0, 0, 0.15),
        0 8px 40px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.9);
      height: 72px;
      display: flex;
      align-items: center;
      border-radius: 2px;
    }

    /* ========================================
       Ticker Content Area
    ======================================== */
    .ticker-content-area {
      position: relative;
      z-index: 2;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      overflow: hidden;
    }

    /* ========================================
       Standard Ticker Mode
    ======================================== */
    .ticker-inner {
      display: inline-block;
      white-space: nowrap;
      will-change: transform;
      transform: translateZ(0);  /* Force GPU layer */
      backface-visibility: hidden;
    }

    .ticker-text {
      display: inline-flex;
      align-items: center;
      gap: 24px;
    }

    .ticker-segment {
      font-family: 'Oswald', sans-serif;
      font-weight: 600;
      font-size: 28px;
      text-transform: uppercase;
      color: #1a1a1a;
      letter-spacing: 1px;
    }

    .ticker-separator {
      color: var(--accent-color, #c41e3a);
      font-size: 20px;
      opacity: 0.6;
    }

    /* ========================================
       Parallax Ticker Mode
    ======================================== */
    .parallax-ticker-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
    }

    .ticker-item {
      display: flex;
      align-items: center;
      width: 100%;
      height: 100%;
    }

    .ticker-item--current {
      position: relative;
    }

    .ticker-item--next {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      pointer-events: none;
    }

    /* Title Badge - Clean broadcast style */
    .ticker-title {
      background: var(--accent-color, #c41e3a);
      padding: 8px 24px;
      flex-shrink: 0;
      will-change: transform, opacity, filter;
      transform-origin: left center;
      position: relative;
      clip-path: polygon(0 0, calc(100% - 12px) 0, 100% 50%, calc(100% - 12px) 100%, 0 100%);
    }

    .ticker-title .title-text {
      font-family: 'Oswald', sans-serif;
      font-weight: 700;
      font-size: 22px;
      color: white;
      text-transform: uppercase;
      letter-spacing: 2px;
      white-space: nowrap;
    }

    /* Separator */
    .ticker-separator-parallax {
      font-size: 28px;
      font-weight: 300;
      color: rgba(0, 0, 0, 0.2);
      margin: 0 20px;
      flex-shrink: 0;
      will-change: transform, opacity, filter;
    }

    /* Content Mask */
    .ticker-content-mask {
      flex: 1;
      overflow: hidden;
      height: 100%;
      display: flex;
      align-items: center;
      position: relative;
      will-change: transform, opacity;
      mask-image: linear-gradient(
        to right,
        transparent 0%,
        black 3%,
        black 97%,
        transparent 100%
      );
      -webkit-mask-image: linear-gradient(
        to right,
        transparent 0%,
        black 3%,
        black 97%,
        transparent 100%
      );
    }

    .ticker-content {
      font-family: 'Source Sans Pro', sans-serif;
      font-weight: 400;
      font-size: 26px;
      font-style: italic;
      color: #333;
      white-space: nowrap;
      will-change: transform;
      padding-right: 50px;
      visibility: hidden;  /* Hide until positioned */
      transform: translateZ(0);  /* Force GPU layer */
      backface-visibility: hidden;
    }

    /* ========================================
       Scanner Line - Subtle paper style
    ======================================== */
    .scanner-container {
      position: absolute;
      left: 0;
      right: 0;
      bottom: 6px;
      height: 3px;
      background: rgba(196, 30, 58, 0.1);
      z-index: 100;
      pointer-events: none;
    }

    .scanner-fill {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 0%;
      background: var(--accent-color, #c41e3a);
      opacity: 0.7;
      will-change: width;
    }

    .scanner-head {
      position: absolute;
      top: 50%;
      left: 0%;
      transform: translate(-50%, -50%);
      width: 12px;
      height: 5px;
      border-radius: 2px;
      background: var(--accent-color, #c41e3a);
      box-shadow: 0 0 6px var(--accent-color, #c41e3a);
      opacity: 0.9;
      will-change: left;
    }

    /* ========================================
       Pinned Comment Display Mode
    ======================================== */
    .pinned-comment-container {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .pinned-type-label {
      font-family: 'Oswald', sans-serif;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--accent-color, #c41e3a);
      flex-shrink: 0;
    }

    .pinned-author {
      font-family: 'Oswald', sans-serif;
      font-weight: 700;
      font-style: italic;
      font-size: 28px;
      color: #1a1a1a;
      text-transform: uppercase;
      flex-shrink: 0;
    }

    .pinned-message {
      font-family: 'Source Sans Pro', sans-serif;
      font-weight: 300;
      font-style: italic;
      font-size: 22px;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding-left: 16px;
      position: relative;
    }

    .pinned-message::before {
      content: '"';
      position: absolute;
      left: 0;
      top: -3px;
      font-size: 28px;
      color: var(--accent-color, #c41e3a);
      font-family: Georgia, serif;
      opacity: 0.5;
    }

    .pinned-amount {
      font-family: 'Oswald', sans-serif;
      font-weight: 600;
      font-size: 22px;
      color: var(--accent-color, #c41e3a);
      flex-shrink: 0;
      margin-left: auto;
    }

    /* ========================================
       Waiting State
    ======================================== */
    .waiting-message {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Oswald', sans-serif;
      font-size: 18px;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 3px;
    }

    /* ========================================
       Superchat Tier Colors
    ======================================== */
    .tier-blue { --accent-color: #1e88e5; }
    .tier-teal { --accent-color: #00bcd4; }
    .tier-yellow { --accent-color: #f9a825; }
    .tier-orange { --accent-color: #f57c00; }
    .tier-magenta { --accent-color: #e91e63; }
    .tier-red { --accent-color: #c41e3a; }

    /* ========================================
       Sports Ticker Style - Semeex Football
    ======================================== */
    @import url('https://fonts.googleapis.com/css2?family=Anton&family=Roboto+Condensed:wght@700&family=Roboto:wght@400;500&display=swap');

    .sports-ticker-wrapper {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 80px;
      background: linear-gradient(to top, #000000 0%, #111111 70%, #1a1a1a 100%);
      display: none;
      box-shadow: 0 -10px 30px rgba(0,0,0,0.7);
    }

    .sports-ticker-wrapper::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(to right,
        #666 0%,
        #fff 15%,
        #999 30%,
        #fff 50%,
        #999 70%,
        #fff 85%,
        #666 100%
      );
      z-index: 100;
    }

    .sports-ticker-wrapper.active {
      display: flex;
      align-items: center;
    }

    .sports-ticker-bar {
      display: flex;
      align-items: center;
      width: 100%;
      height: 100%;
      position: relative;
      overflow: hidden;
    }

    /* Logo Area */
    .sports-logo-wrapper {
      position: relative;
      z-index: 10;
      height: 100%;
      display: flex;
      align-items: center;
      padding-left: 20px;
      padding-right: 30px;
      flex-shrink: 0;
    }

    .sports-logo {
      height: 50px;
      width: auto;
      filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.7));
    }

    /* Content Area - single row with pill and description */
    .sports-content-area {
      flex: 1;
      height: 100%;
      display: flex;
      align-items: center;
      position: relative;
      overflow: hidden;
    }

    /* Topic Pill - Animated - centered */
    .sports-topic-pill {
      display: inline-flex;
      height: 45px;
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 3px 12px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.1);
      z-index: 20;
      font-family: 'Roboto Condensed', sans-serif;
      text-transform: uppercase;
      opacity: 0;
      flex-shrink: 0;
      position: relative;
      filter: blur(0px);
      transform-origin: left center;
    }

    .sports-topic-text {
      background: linear-gradient(to bottom, #ffea00 0%, #e6c700 100%);
      color: #000;
      padding: 0 20px;
      display: flex;
      align-items: center;
      font-family: 'Special Gothic Expanded One', sans-serif;
      font-size: 22px;
      font-weight: 400;
      letter-spacing: 1px;
    }

    /* Description Scroll Area - scrolls BEHIND the pill */
    .sports-ticker-display {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      overflow: hidden;
      z-index: 10; /* Behind the pill (z-index 20) */
    }

    .sports-description-track {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      overflow: hidden;
    }

    .sports-content {
      position: absolute;
      white-space: nowrap;
      color: white;
      font-family: 'Bebas Neue', sans-serif;
      font-size: 28px;
      font-weight: 400;
      letter-spacing: 1px;
      will-change: transform;
      left: 0;
      /* Position controlled by GSAP transform */
      transform: translateZ(0);  /* Force GPU layer */
      backface-visibility: hidden;
    }

    /* Hide unused elements */
    .sports-brand-pill,
    .sports-brand-badge,
    .sports-category-badge,
    .sports-topic,
    .sports-separator,
    .sports-scrolling-content,
    .sports-ticker-underline {
      display: none;
    }
  </style>
</head>
<body>
  <div id="tickerWrapper" class="ticker-wrapper">
    <!-- Top accent bar -->
    <div class="accent-bar-top" id="accentTop"></div>

    <!-- Main Panel -->
    <div class="ticker-paper">
      <div class="ticker-content-area" id="tickerContent">
        <div class="waiting-message">Connecting to server...</div>
      </div>
    </div>

    <!-- Bottom accent bar -->
    <div class="accent-bar-bottom" id="accentBottom"></div>

    <!-- Scanner -->
    <div class="scanner-container">
      <div class="scanner-fill" id="scannerFill"></div>
      <div class="scanner-head" id="scannerHead"></div>
    </div>
  </div>

  <!-- Sports Style Ticker -->
  <div id="sportsTickerWrapper" class="sports-ticker-wrapper">
    <div class="sports-ticker-bar">
      <!-- Logo Area -->
      <div class="sports-logo-wrapper">
        <img id="sportsLogo" class="sports-logo" src="" alt="">
      </div>

      <!-- Content Area - Topic Pill above, Description below -->
      <div class="sports-content-area">
        <!-- Topic Pill (animated) -->
        <div class="sports-topic-pill" id="sportsTopicPill">
          <div class="sports-topic-text" id="sportsTopic">TOPIC</div>
        </div>

        <!-- Description Scroll Area (underneath pill) -->
        <div class="sports-ticker-display" id="sportsTickerDisplay">
          <div class="sports-description-track">
            <span id="sportsContent" class="sports-content">Description of the news item goes here</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========================================================================
    // Configuration from URL parameters
    // ========================================================================
    const params = new URLSearchParams(window.location.search);
    const config = {
      mode: params.get('mode') || 'parallax',  // 'ticker', 'parallax', 'pinned'
      speed: parseInt(params.get('speed')) || 100
    };

    // ========================================================================
    // State
    // ========================================================================
    let ws = null;
    let tickerItems = [];
    let pinnedMessage = null;
    let tickerSpeed = config.speed;
    let showTicker = true;
    let tickerStyle = 'standard';
    let sportsTicker = { brand: 'SEMEEX', category: 'FOOTBALL', logoUrl: '' };
    let currentIndex = 0;
    let isTransitioning = false;
    let scrollAnimation = null;

    // DOM Elements - Standard Style
    const wrapper = document.getElementById('tickerWrapper');
    const accentTop = document.getElementById('accentTop');
    const accentBottom = document.getElementById('accentBottom');

    // DOM Elements - Sports Style
    const sportsWrapper = document.getElementById('sportsTickerWrapper');
    const sportsLogo = document.getElementById('sportsLogo');
    const sportsTopicPill = document.getElementById('sportsTopicPill');
    const sportsTopicEl = document.getElementById('sportsTopic');
    const sportsContentEl = document.getElementById('sportsContent');
    const sportsTickerDisplay = document.getElementById('sportsTickerDisplay');
    let sportsCurrentIndex = 0;
    let sportsAnimationTimeline = null;

    // DOM refs for parallax ticker
    let currentTitleEl = null;
    let currentSeparatorEl = null;
    let currentContentMaskEl = null;
    let currentContentEl = null;
    let nextTitleEl = null;
    let nextSeparatorEl = null;
    let nextContentMaskEl = null;
    let nextContentEl = null;

    // ========================================================================
    // Animate wrapper in
    // ========================================================================
    function animateWrapperIn() {
      // Set initial states
      gsap.set(wrapper, { opacity: 0, y: 20 });
      gsap.set(accentTop, { scaleX: 0, transformOrigin: 'left center' });
      gsap.set(accentBottom, { scaleX: 0, transformOrigin: 'right center' });

      const tl = gsap.timeline();

      // Wrapper fades in
      tl.to(wrapper, { opacity: 1, y: 0, duration: 0.4, ease: 'power3.out' });

      // Accent bars sweep in
      tl.to(accentTop, { scaleX: 1, duration: 0.5, ease: 'power4.out' }, '-=0.2');
      tl.to(accentBottom, { scaleX: 1, duration: 0.5, ease: 'power4.out' }, '-=0.35');
    }

    // ========================================================================
    // WebSocket Connection
    // ========================================================================
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}`;

      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log('[Ticker] WebSocket connected');
        animateWrapperIn();
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          handleMessage(data);
        } catch (e) {
          console.error('[Ticker] Parse error:', e);
        }
      };

      ws.onclose = () => {
        console.log('[Ticker] WebSocket disconnected, reconnecting...');
        setTimeout(connectWebSocket, 2000);
      };

      ws.onerror = (error) => {
        console.error('[Ticker] WebSocket error:', error);
      };
    }

    function handleMessage(data) {
      console.log('[Ticker] Received message:', data.type, data.data);

      switch (data.type) {
        case 'init':
          tickerItems = data.data.tickerItems || [];
          pinnedMessage = data.data.pinnedMessage;
          tickerSpeed = data.data.tickerSpeed || config.speed;
          showTicker = data.data.showTicker !== false;
          if (data.data.tickerStyle) tickerStyle = data.data.tickerStyle;
          if (data.data.sportsTicker) sportsTicker = data.data.sportsTicker;
          console.log('[Ticker] Init with', tickerItems.length, 'items, style:', tickerStyle);
          updateTickerStyle();
          initTicker();
          break;

        case 'pin':
          pinnedMessage = data.data.message;
          if (config.mode === 'pinned') {
            renderPinnedMode();
          }
          break;

        case 'ticker_update':
          console.log('[Ticker] Update with', data.data.tickerItems?.length, 'items, style:', data.data.tickerStyle, 'speed:', data.data.tickerSpeed);
          const itemsChanged = data.data.tickerItems !== undefined;
          const speedChanged = data.data.tickerSpeed !== undefined && data.data.tickerSpeed !== tickerSpeed;
          if (data.data.tickerItems) tickerItems = data.data.tickerItems;
          if (data.data.tickerSpeed !== undefined) tickerSpeed = data.data.tickerSpeed;
          if (data.data.showTicker !== undefined) showTicker = data.data.showTicker;
          if (data.data.tickerStyle) tickerStyle = data.data.tickerStyle;
          if (data.data.sportsTicker) sportsTicker = data.data.sportsTicker;
          updateTickerStyle();
          // Re-initialize if items or speed changed
          if (itemsChanged || speedChanged) {
            initTicker();
          }
          break;

        case 'queue_update':
          // Can update ticker based on queue if needed
          break;
      }
    }

    // ========================================================================
    // Ticker Initialization
    // ========================================================================
    function initTicker() {
      console.log('[Ticker] Initializing mode:', config.mode, 'items:', tickerItems.length, 'showTicker:', showTicker, 'style:', tickerStyle);

      // If sports style, handle differently
      if (tickerStyle === 'sports') {
        wrapper.style.display = 'none';
        sportsWrapper.classList.add('active');
        updateSportsContent();
        return;
      }

      // Tape style
      wrapper.style.display = showTicker ? 'block' : 'none';
      sportsWrapper.classList.remove('active');

      switch (config.mode) {
        case 'ticker':
          initStandardTicker();
          break;
        case 'parallax':
          initParallaxTicker();
          break;
        case 'pinned':
          renderPinnedMode();
          break;
        default:
          initParallaxTicker();
      }
    }

    // ========================================================================
    // Sports Ticker Content Update
    // ========================================================================
    function updateSportsContent() {
      // Handle logo
      if (sportsTicker.logoUrl) {
        sportsLogo.src = sportsTicker.logoUrl;
        sportsLogo.style.display = 'block';
        sportsLogo.parentElement.style.display = 'flex';
      } else {
        sportsLogo.style.display = 'none';
        sportsLogo.parentElement.style.display = 'none';
      }

      // Start the sports ticker animation loop
      if (tickerItems.length > 0) {
        sportsCurrentIndex = 0;
        playSportsTickerItem();
      } else {
        sportsTopicEl.textContent = 'NEWS';
        sportsContentEl.textContent = 'No ticker content available';
      }
    }

    // Play a single sports ticker item with parallax animation
    function playSportsTickerItem() {
      if (tickerItems.length === 0) return;

      // Kill any existing animation
      if (sportsAnimationTimeline) {
        sportsAnimationTimeline.kill();
      }

      const item = tickerItems[sportsCurrentIndex];

      // Update content
      sportsTopicEl.textContent = item.title || 'NEWS';
      sportsContentEl.textContent = item.content || 'Description of the news item goes here';

      // Force reflow to get accurate dimensions
      void sportsContentEl.offsetWidth;

      // Get dimensions for animation calculations
      const contentArea = document.querySelector('.sports-content-area');
      const areaWidth = contentArea ? contentArea.offsetWidth : 1600;
      const contentWidth = sportsContentEl.offsetWidth;
      const pillWidth = sportsTopicPill.offsetWidth || 200;
      const scrollSpeed = tickerSpeed || 200; // Use tickerSpeed from settings

      // Total distance: from off-screen right to off-screen left
      const totalDistance = areaWidth + contentWidth;
      const scrollDuration = totalDistance / scrollSpeed;

      // Calculate when text has FULLY passed behind the pill
      const timeForTextToPassPill = (areaWidth + contentWidth + 50) / scrollSpeed;

      console.log('[Sports] Scroll duration:', scrollDuration.toFixed(2), 'Speed:', scrollSpeed);

      // Create GSAP timeline for the animation sequence
      sportsAnimationTimeline = gsap.timeline({
        onComplete: () => {
          // Move to next item when complete
          sportsCurrentIndex = (sportsCurrentIndex + 1) % tickerItems.length;
          // Minimal delay before next item
          setTimeout(playSportsTickerItem, 50);
        }
      });

      // Reset initial states with organic offsets
      gsap.set(sportsTopicPill, {
        opacity: 0,
        x: -60,
        scale: 0.85,
        rotation: 2,
        filter: 'blur(6px)',
        boxShadow: '0 3px 12px rgba(0,0,0,0.5)'
      });
      gsap.set(sportsContentEl, {
        x: areaWidth,
        opacity: 0
      });

      // Phase 1: Topic pill enters quickly
      sportsAnimationTimeline.to(sportsTopicPill, {
        opacity: 1,
        x: 0,
        scale: 1,
        rotation: 0,
        filter: 'blur(0px)',
        boxShadow: '0 4px 15px rgba(255,234,0,0.4), 0 3px 10px rgba(0,0,0,0.5)',
        duration: 0.35,
        ease: 'back.out(1.2)'
      });

      // Phase 2: Description fades in immediately
      sportsAnimationTimeline.to(sportsContentEl, {
        opacity: 1,
        duration: 0.2,
        ease: 'power2.out'
      }, '-=0.2');

      // Phase 3: Description scrolls across
      sportsAnimationTimeline.to(sportsContentEl, {
        x: -contentWidth - 50,
        duration: scrollDuration,
        ease: 'none',
        force3D: true  // Force GPU acceleration
      }, '-=0.1');

      // Phase 4: Topic pill exits quickly
      sportsAnimationTimeline.to(sportsTopicPill, {
        opacity: 0,
        x: -50,
        scale: 0.9,
        filter: 'blur(4px)',
        duration: 0.25,
        ease: 'power2.in'
      }, '>-0.3');

      // Phase 5: Description fades out
      sportsAnimationTimeline.to(sportsContentEl, {
        opacity: 0,
        duration: 0.15,
        ease: 'power2.in'
      }, '>-0.2');
    }

    // ========================================================================
    // Standard Ticker Mode
    // ========================================================================
    function initStandardTicker() {
      const container = document.getElementById('tickerContent');

      if (tickerItems.length === 0) {
        container.innerHTML = '<div class="waiting-message">No ticker content</div>';
        return;
      }

      // Build ticker content
      const segments = tickerItems.map((item, i) => {
        const text = item.content || item.title || '';
        return `<span class="ticker-segment">${escapeHtml(text)}</span>`;
      }).join('<span class="ticker-separator">•</span>');

      // Repeat 3x for seamless scrolling
      const repeated = `
        <span class="ticker-repeat">${segments}<span class="ticker-separator">•</span></span>
        <span class="ticker-repeat">${segments}<span class="ticker-separator">•</span></span>
        <span class="ticker-repeat">${segments}<span class="ticker-separator">•</span></span>
      `;

      container.innerHTML = `
        <div class="ticker-inner" id="tickerInner">
          <span class="ticker-text">${repeated}</span>
        </div>
      `;

      // Start GSAP animation
      const tickerInner = document.getElementById('tickerInner');
      const tickerText = tickerInner.querySelector('.ticker-text');
      const textWidth = tickerText.offsetWidth / 3;  // One repeat width

      gsap.killTweensOf(tickerInner);
      gsap.set(tickerInner, { x: 0 });

      const duration = textWidth / tickerSpeed;

      gsap.to(tickerInner, {
        x: -textWidth,
        duration: duration,
        ease: 'none',
        force3D: true,  // Force GPU acceleration
        repeat: -1,
        onUpdate: function() {
          const progress = this.progress() * 100;
          updateScanner(progress);
        },
        onRepeat: () => {
          gsap.set(tickerInner, { x: 0 });
        }
      });
    }

    // ========================================================================
    // Parallax Ticker Mode
    // ========================================================================
    function initParallaxTicker() {
      const container = document.getElementById('tickerContent');
      console.log('[Ticker] initParallaxTicker called with', tickerItems.length, 'items');

      if (tickerItems.length === 0) {
        container.innerHTML = '<div class="waiting-message">No ticker content</div>';
        console.log('[Ticker] No items, showing empty message');
        return;
      }

      currentIndex = 0;
      const currentItem = tickerItems[currentIndex];
      const nextIndex = tickerItems.length > 1 ? 1 : 0;
      const nextItem = tickerItems[nextIndex];

      container.innerHTML = `
        <div class="parallax-ticker-container">
          <!-- Current Item -->
          <div class="ticker-item ticker-item--current">
            <div class="ticker-title" id="currentTitle">
              <span class="title-text">${escapeHtml(currentItem.title || 'NEWS')}</span>
            </div>
            <div class="ticker-separator-parallax" id="currentSeparator">::</div>
            <div class="ticker-content-mask" id="currentContentMask">
              <div class="ticker-content" id="currentContent">${escapeHtml(currentItem.content || '')}</div>
            </div>
          </div>

          <!-- Next Item (for transition) -->
          ${tickerItems.length > 1 ? `
          <div class="ticker-item ticker-item--next">
            <div class="ticker-title" id="nextTitle">
              <span class="title-text">${escapeHtml(nextItem.title || 'NEWS')}</span>
            </div>
            <div class="ticker-separator-parallax" id="nextSeparator">::</div>
            <div class="ticker-content-mask" id="nextContentMask">
              <div class="ticker-content" id="nextContent">${escapeHtml(nextItem.content || '')}</div>
            </div>
          </div>
          ` : ''}
        </div>
      `;

      // Get DOM refs
      currentTitleEl = document.getElementById('currentTitle');
      currentSeparatorEl = document.getElementById('currentSeparator');
      currentContentMaskEl = document.getElementById('currentContentMask');
      currentContentEl = document.getElementById('currentContent');
      nextTitleEl = document.getElementById('nextTitle');
      nextSeparatorEl = document.getElementById('nextSeparator');
      nextContentMaskEl = document.getElementById('nextContentMask');
      nextContentEl = document.getElementById('nextContent');

      // Hide next item initially
      if (nextTitleEl) {
        gsap.set([nextTitleEl, nextSeparatorEl], { x: 60, opacity: 0, scale: 0.9, filter: 'blur(4px)' });
        gsap.set(nextContentMaskEl, { opacity: 0, x: 30 });
      }

      // Wait for DOM to be ready, then position off-screen and start scrolling
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          const maskWidth = currentContentMaskEl.offsetWidth;
          gsap.set(currentContentEl, { x: maskWidth });
          startParallaxContentScroll();
        });
      });
    }

    function startParallaxContentScroll() {
      if (!currentContentEl || !currentContentMaskEl) return;

      if (scrollAnimation) {
        scrollAnimation.kill();
      }

      const contentWidth = currentContentEl.offsetWidth;
      const maskWidth = currentContentMaskEl.offsetWidth;
      const startX = maskWidth;
      const scrollDistance = startX + contentWidth;
      const duration = scrollDistance / tickerSpeed;

      // Reset scanner
      updateScanner(0);

      // Position off-screen THEN make visible
      gsap.set(currentContentEl, { x: startX, visibility: 'visible' });

      scrollAnimation = gsap.to(currentContentEl, {
        x: -contentWidth,
        duration: duration,
        ease: 'none',
        force3D: true,  // Force GPU acceleration
        onUpdate: function() {
          const progress = this.progress() * 100;
          updateScanner(progress);
        },
        onComplete: () => {
          updateScanner(0);
          if (tickerItems.length > 1) {
            transitionToNext();
          } else {
            startParallaxContentScroll();  // Single item - restart
          }
        }
      });
    }

    function transitionToNext() {
      if (isTransitioning) return;
      isTransitioning = true;

      const tl = gsap.timeline({
        onComplete: () => {
          currentIndex = (currentIndex + 1) % tickerItems.length;
          updateParallaxItems();
          isTransitioning = false;
        }
      });

      // Phase 1: Current exits quickly
      tl.to(currentTitleEl, {
        x: -60,
        opacity: 0,
        scale: 0.9,
        filter: 'blur(4px)',
        duration: 0.25,
        ease: 'power2.in'
      });

      tl.to(currentSeparatorEl, {
        x: -40,
        opacity: 0,
        duration: 0.2,
        ease: 'power2.in'
      }, '-=0.2');

      tl.to(currentContentMaskEl, {
        opacity: 0,
        x: -30,
        duration: 0.2,
        ease: 'power2.in'
      }, '-=0.2');

      // Phase 2: Next enters quickly
      if (nextTitleEl) {
        tl.fromTo(nextTitleEl,
          { x: 50, opacity: 0, scale: 0.9, filter: 'blur(4px)' },
          {
            x: 0,
            opacity: 1,
            scale: 1,
            filter: 'blur(0px)',
            duration: 0.3,
            ease: 'back.out(1.2)'
          },
          '-=0.1'
        );

        tl.fromTo(nextSeparatorEl,
          { x: 30, opacity: 0 },
          { x: 0, opacity: 1, duration: 0.25, ease: 'power2.out' },
          '-=0.2'
        );

        tl.fromTo(nextContentMaskEl,
          { opacity: 0, x: 30 },
          { opacity: 1, x: 0, duration: 0.25, ease: 'power2.out' },
          '-=0.15'
        );
      }
    }

    function updateParallaxItems() {
      const currentItem = tickerItems[currentIndex];
      const nextIndex = (currentIndex + 1) % tickerItems.length;
      const nextItem = tickerItems[nextIndex];

      // Hide content immediately before updating text
      gsap.set(currentContentEl, { visibility: 'hidden' });

      // Reset current item visibility
      gsap.set([currentTitleEl, currentSeparatorEl], { x: 0, opacity: 1, scale: 1, filter: 'blur(0px)' });
      gsap.set(currentContentMaskEl, { x: 0, opacity: 1 });

      // Update content text
      currentTitleEl.querySelector('.title-text').textContent = currentItem.title || 'NEWS';
      currentContentEl.textContent = currentItem.content || '';

      // Update and hide next item
      if (nextTitleEl) {
        nextTitleEl.querySelector('.title-text').textContent = nextItem.title || 'NEWS';
        nextContentEl.textContent = nextItem.content || '';
        gsap.set([nextTitleEl, nextSeparatorEl], { x: 60, opacity: 0, scale: 0.9, filter: 'blur(4px)' });
        gsap.set(nextContentMaskEl, { opacity: 0, x: 30 });
        gsap.set(nextContentEl, { visibility: 'hidden' });
      }

      // Wait for DOM to update, then position off-screen and start scrolling
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          startParallaxContentScroll();
        });
      });
    }

    // ========================================================================
    // Pinned Comment Mode
    // ========================================================================
    function renderPinnedMode() {
      const container = document.getElementById('tickerContent');

      if (!pinnedMessage) {
        container.innerHTML = '<div class="waiting-message">No pinned comment</div>';
        return;
      }

      const isSuperchat = pinnedMessage.isSuperchat || pinnedMessage.type === 'superchat';

      container.innerHTML = `
        <div class="pinned-comment-container">
          <div class="pinned-type-label">${isSuperchat ? 'SUPERCHAT' : 'COMMENT'}</div>
          <div class="pinned-author">${escapeHtml(pinnedMessage.author || pinnedMessage.username)}</div>
          <div class="pinned-message">${escapeHtml(pinnedMessage.message)}</div>
          ${isSuperchat ? `<div class="pinned-amount">${pinnedMessage.amountFormatted || '$' + pinnedMessage.amount}</div>` : ''}
        </div>
      `;
    }

    // ========================================================================
    // Scanner Updates (throttled for performance)
    // ========================================================================
    let lastScannerUpdate = 0;
    function updateScanner(progress) {
      // Throttle to ~30fps to reduce DOM updates
      const now = performance.now();
      if (now - lastScannerUpdate < 33 && progress > 0 && progress < 100) return;
      lastScannerUpdate = now;

      const fill = document.getElementById('scannerFill');
      const head = document.getElementById('scannerHead');
      if (fill) fill.style.width = `${progress}%`;
      if (head) head.style.left = `${progress}%`;
    }

    // ========================================================================
    // Style Switching
    // ========================================================================
    function updateTickerStyle() {
      console.log('[Ticker] Updating style to:', tickerStyle);

      if (tickerStyle === 'sports') {
        // Hide standard style, show sports style
        wrapper.style.display = 'none';
        sportsWrapper.classList.add('active');
        updateSportsContent();
      } else {
        // Show standard style, hide sports style
        wrapper.style.display = showTicker ? 'block' : 'none';
        sportsWrapper.classList.remove('active');
      }
    }

    // ========================================================================
    // Utilities
    // ========================================================================
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ========================================================================
    // Initialize
    // ========================================================================
    connectWebSocket();

    // Test mode
    if (params.get('test') === 'true') {
      setTimeout(() => {
        tickerItems = [
          { title: 'BREAKING', content: 'This is the first ticker item with important news for your broadcast' },
          { title: 'SPORTS', content: 'Second item showcasing the parallax transition effect with smooth animations' },
          { title: 'WEATHER', content: 'Third item demonstrating the clean broadcast ticker design' }
        ];
        showTicker = true;
        animateWrapperIn();
        initTicker();
      }, 500);
    }
  </script>
</body>
</html>
